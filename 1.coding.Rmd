---
title: "Coding Exercise"
author: "Jeongim Jin"
date: "October 22, 2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(eval = TRUE, error = TRUE)
```

Before getting started, place this file in the project folder we started during
class. Click the "knit" button near the top of RStudio. You should get an HTML
output. If not raise your hand and I will come help you. Once you have
successfully knit the file, you can proceed with the rest of the lab.


## Scenario
A local school district is interested in how their third grade students are 
performing on an end-of-year tests. There have been major efforts to reduce
achievement disaprities. For this particular investigation, they are 
primarily interested in how large the achievement gaps remain on the end of 
year tests. A secondary question, however, relates to how large student gains
in reading are from the fall to the spring, while controlling for specific 
student demographics.

1. Place the "benchmarks.xlsx" dataset (from Canvas) into a folder in your 
RStudio Project called "data". Using the code chunk below, fill in the 
code to load the data into R and store it in an object, `d`. 

```{r load-data, message = FALSE, warning = FALSE}
library(tidyverse)
library(rio)
library(here)
d <- import(here("data", "benchmarks.xlsx"),
            setclass = "tbl_df")
d
```

2. In the code-chunk below, use a few functions to explore the data.

```{r, show-data}
head(d)

ggplot(d, aes(sped))+
  geom_bar(alpha = 0.7)

ggplot(d, aes(ethnicity)) + 
  geom_bar(alpha = 0.7)

ggplot(d, aes(frl))+
  geom_bar (alpah = 0.7)

ggplot(d, aes(ell))+
  geom_bar(alpha = 0.7)

```

# Research Question 1
> What are the average differences on the spring reading measure among students
receiving English language learner services by ethnicity?

3. Modify the code chunk below to define all categorical variables as factors.

```{r factorize, message = FALSE, warning = FALSE}
library(tidyverse)
d <- d %>% 
  mutate(sped = factor(sped),
         ethnicity = factor(ethnicity),
         frl = factor(frl),
         ell = factor(ell))
head(d)
```


4. Write the code to display boxplots of students' spring reading scores 
by ELL status and ethnicity. Hint: You will need to either use `facet_wrap` or
add an additional aesthetic (`fill` or `color`) to the boxplot layer.

```{r boxplots}
ggplot(d, aes(ell, rdg_spr)) +
  geom_boxplot()+
  facet_wrap(~ethnicity)

ggplot(d, aes(ell, rdg_spr)) +
  geom_boxplot(aes (fill = ethnicity))
```

4. Fit the corresponding model

$$
rdg_{spr} = b_0 + b_1(ELL_i) + b_2(Ethnicity_i) + e
$$

```{r m1a}
m1a <- lm(rdg_spr ~ ell + ethnicity, d)
arm::display(m1a, detail = TRUE ) 
```

Provide a substantive interpretation of the model below, making sure to 
interpret the intercept and at least one slope from each group, as well as the model $R^2$.

----

#### Substantive Interpretation
The average spring reading score is expected to be 187.91 for ELL American-Indian students who need active supports of English as a reference group.  

ELL-monitored students are expected to be 11.71 higher on average in spring reading score compared to ELL American-indian students who need active supports of English controlling for ethnicity. This result is significant (p <.001).

Non-ELL students are expected to be 11.09 higher in spring reading score on average 11.09 points compared to Ell American-Indian students who need active supports of English controlling for ethnicity. This result is significant (p <.001).

All ethniticities, except for two groups of White and Aisans, display a little lower reading scores on average than the reference group of ELL American-Indican students who need active supports of English controlling for ELL (Black = - 1.81, Hispanic = -0.74, and Native American = 5.27). The other two groups, Asian and White, display higher average scores than the reference group (Asian = + 11.85, White = +8.34). All these results indicate not significant ( p > .05), implying that the spring reading scores are likely to be determined by the degree of English proficiency not by ethnicity. 

Around 23 % of variaances in spring reading scores can be explained by ell and ethnicity.

----

5. Modify the code below to change the reference group to Students identifying as "White" who did not receive English language services. Remember, you'll need use the `relevel` function.

```{r change-ref-group}
d <- d %>% 
  mutate (ell = relevel(ell, ref = "Non-ELL"),
         ethnicity = relevel(ethnicity, ref = "White"))

```

6. Re-fit the model

```{r m1b}
m1b <- lm(rdg_spr ~ ell + ethnicity, d)
arm::display(m1b, detail = TRUE ) 
  
```

Has the variance accounted for by the model changed? Why?

Provide a brief substantive interpretation of the re-fit model.


----

#### Substantive Interpretation
One additional variance of ethiniciy are added to the re-fit model to explaian the score differences. This is because the reference group has been chagned from ELL American-Indians to Non-ELL Whites.   

R^2 has not changed even though the reference group changed. I guess, since the same indepdent variables are used in finding the factors affecting spring reading scores, the variances of the spring reading score are explained by the same proportion of 23%.  

The average spring reading score is expected to be 207.34 for non-ELL White students as a reference group.  

ELL students who need active supports of English are expected to be 11. 09 compared to non-ELL students controlling for ethnicity. This result is significant (p <.001).

Black students are expected to be 10.15 lower in spring reading score; Hispanic students are 9.08 lower on average, and Native American studetns are 13.62 lower on avaerage compared to White students controlling for ELL. This result is significant (p <.001).

The other variables, ELL-monitored, American-Indican, and Asian students, exhibit the gap in the reading scores between non-ELL White students (ELL-monitored students = +0.62, American-Indican students = - 8.34, and Aisan students = 3.50). However, all these results indicate not significant ( p > .05).

This re-fit model explains that the spring reading score can be predicted by both factors of English profiency and ethinicty.
----

# Research Question 2
> What is the average reading score gain from fall to spring, controlling for
ethnicity?

7. Write code using ggplot to visualize the relation between the fall and 
spring reading scores, using spring as the outcome. Display the linear 
regression line.

```{r scatter1}
ggplot(d, aes(rdg_fall, rdg_spr)) +
  geom_point()+
  geom_smooth(method = "lm", 
              se = FALSE, 
              size = 1.5)
  
```

Copy and paste the code you wrote above and paste it in the chunk below. Add 
an additional aesthetic to the smoothed layer to display separate lines by 
English language learner status (ell column).

```{r scatter2}
m2a <- lm(rdg_spr ~ethnicity + rdg_fall, d)
arm::display(m2a, detail = TRUE)

d <- d %>% 
  mutate (pred_m2a = predict(m2a))

ggplot(d, aes(rdg_fall, rdg_spr)) +
  geom_point()+
  geom_smooth(aes(y = pred_m2a, color = ethnicity),
              method = "lm", 
              se = FALSE, 
              size = 1.5)
  
```

Provide some substantive interpretation of the above plot.


----

#### Substantive Interpretation

All six regression lines display the same slope, which means contorlling for ethnicity. The graph indicates that as one unit of increase in fall reading score, spring reading score is expected to increase around 0.4 unit in spring reading score.
----

8. Fill in the code chunk below to fit the following model to address the 
research question.

$$
rdg_{spr_i} = b_0 + b_1(rdg_{fall_i}) + b_2(Ethnicity_i) + e
$$

```{r m2a}
contrasts(d$ethnicity)

m2a <- lm(rdg_spr ~ rdg_fall + ethnicity, d)
arm::display(m2a, detail = TRUE ) 

```

Display a summary of the model. Put your interpretation below, specifically 
stating what the coefficients (intercept and slope) represent. Does this model correspond to the plot you've displayed above? Why or why not?


----

#### Substantive Interpretation
The expected spring reading score is 135.73 on average for White students as a reference group controlling when fall reading score is 0.  
 
When one unit of fall reading score increase, spring reading score increase 0.36 per unit contorlling for ethnicity. This finding is significant (p < .001).

Hispanic students are expected to be 8.36 lower compared to White students. Native American students are expected to 11.26 lower compared to White student controlling for fall reading score. These results indicate significant (p < .05)

American indians, Asians, and Blacks display some gap between White students controlling for fall reading score. This result is not significant (p > .05)

Ethnicity can explain around 26 percentage of the variance of spring reading scores. 

This model corresponded to the polot above. The graph indicats parrelled slopes with different intercepts. In other words, having different intercepts means that for student having the same fall reading scores, spring reading score depends on their ethnic group. Having parrelled slpes means that the effect of fall reading scores are the same for students in the same ethnic group.

9. Modify the code chunk below to change the contrasts for ethnicity to effect coding .

```{r effect-code}
contrasts(d$ethnicity) <- contr.sum(6)

contrasts(d$ethnicity)
```

10. Refit the model

```{r effect-coded-mod}
m2b <- lm(rdg_spr ~ rdg_fall + ethnicity, d)
arm::display(m2b, detail = TRUE )  
```

Interpret the model with the effect-coded ethnicity variable. Again note why 
$R^2$ was or was not changed, state what the intercept represents, and 
interpret the coefficients substantively.


----

#### Substantive Interpretation
The expected spring reading score is 130.73 on average for Native American students(ethinicity 6) as a reference group controlling fall reading score.
 
When one unit of fall reading score increase, spring reading score increase 0.36 per unit contorlling for ethnicity. This finding is significant (p < .001).

Ethnicity 1 is expected to be 4.96 higher compared to the refence group. This result indicates significant (p = .05)

Ethnicity 2,3,4, and 5 display some gaps between the reference group controlling for fall reading score. This result is not significant (p > .05)

Ethnicity and fall reading score can explain 26 percentage of the variance of the spring reading score. Although using effect coding, IVs and DVs are the same. Thus, variance explained is not likely to change.  

----

Knit the document and upload it to Canvas.